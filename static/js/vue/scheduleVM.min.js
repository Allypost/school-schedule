function getWeek(){var e=new Date,t=new Date(e.getFullYear(),0,1),a=864e5,r=Math.ceil(((e-t)/a+t.getDay()+1)/7);return r%2+1}var getScheduleMatrix=function(){function e(){var e={},a=[1,2],r=["mon","tue","wed","thu","fri"],n=Array.apply(null,new Array(5)).map(function(e,t){return t+1});for(var i in a)if(a.hasOwnProperty(i)){var o=a[i];e[o]||(e[o]={});for(var s in r)if(r.hasOwnProperty(s)){var u=r[s];e[o][u]||(e[o][u]={});for(var c in n)if(n.hasOwnProperty(c)){var d=n[c];e[o][u][d]={id:null,owner:null,name:"",subject:"",status:"",due:null,week:null,day:null,period:null,owned:!1,hasClass:!1,isLoading:!1}}}}return t(e)}function t(e){return localStorage&&localStorage.setItem&&localStorage.setItem(r,JSON.stringify(e)),e}function a(){if(!localStorage||!localStorage.getItem)return!1;var e=localStorage.getItem(r);return e&&JSON.parse(e)}var r="scheduleVM:schedule:matrix";return a()||e()};window.scheduleVM=new Vue({el:"#schedule",data:{week:getWeek(),days:["mon","tue","wed","thu","fri"],schedule:getScheduleMatrix(),teaching:{},statuses:{Cancelled:"Cancelled",Normal:""},lastFetch:0,isLoaded:!1},computed:{isTeacher:function(){return!!parseInt($(this.$el).attr("data-teacher"))}},filters:{lower:function(e){return e.toString().toLowerCase()},capitalize:function(e){return e?(e=e.toString(),e.charAt(0).toUpperCase()+e.slice(1)):""}},methods:{getLocation:function(e){return{week:e.week,day:e.day,period:e.period}},subjectChange:function(e,t,a){var r=e[e.selectedIndex],n=Number(r.value),i=r.innerText;t.week=a.week,t.day=a.day,t.period=a.period,t.name=i,t.hasClass=!0,t.owned=!0,t.isLoading=!0,a.subject=n,this.subjectPropagate(a,function(e,a){return t.isLoading=!1,"error"==a?void Materialize.toast("An error occured",3e3,"status error"):void(t.hasClass=e.data["new"].hasClass)})},setStatus:function(e,t,a){e.status=t,e.isLoading=!0,a.status=t,this.statusPropagate(a,function(t,a){e.isLoading=!1,"error"==a&&Materialize.toast("An error occured",3e3,"status error")})},statusPropagate:function(e,t){var a=$(this.$el).attr("data-status");return this.dataPropagate(e,a,t)},subjectPropagate:function(e,t){var a=$(this.$el).attr("data-subject");return this.dataPropagate(e,a,t)},dataPropagate:function(e,t,a){return e[$('meta[name="csrf_key"]').attr("content")]=$('meta[name="csrf"]').attr("content"),$.post(t,e).done(function(e){a(e,"success")}).fail(function(e){a(e,"error")})},highlightClass:function(e){if(!e.owned){var t=this.getLocation(e),a="schedule-hour-highlight",r="span[data-week='{0}'][data-day='{1}'][data-period='{2}']".format(t.week,t.day,t.period),n=$(r).parent();n.addClass(a),setTimeout(function(){n.removeClass(a)},850)}},getScheduleUrl:function(){return $(this.$el).attr("data-schedule")},fetchSchedule:function(e,t){var a=this,r=a.getScheduleUrl();t&&(r+="/"+this.lastFetch),$.get(r).done(function(r){e(r,a,t),a.lastFetch=r.timestamp}).fail(function(){Materialize.toast("Couldn't get schedule!",3e3,"status error")})},setSchedule:function(e,t){for(var a in e)if(e.hasOwnProperty(a)){var r=e[a],n=r.week,i=r.day,o=r.period;r.isLoading=!1,this.schedule[n][i][o]=r,t&&this.highlightClass(this.schedule[n][i][o])}this.$forceUpdate()},getTeachingUrl:function(){return $(this.$el).attr("data-teaching")},fetchTeaching:function(e){var t=this,a=t.getTeachingUrl();$.get(a).done(function(a){e(a,t)}).fail(function(){Materialize.toast("Couldn't get classes!",3e3,"status error")})},setTeaching:function(e){for(var t in e)if(e.hasOwnProperty(t)){var a=e[t];this.teaching[a.id]=a}this.$forceUpdate()}},mounted:function(){var e=this;$(document).ready(function(){scheduleVM.fetchSchedule(function(e,t){t.setSchedule(e.data)}),e.isTeacher&&scheduleVM.fetchTeaching(function(e,t){var a=e.data;t.teaching[0]={due:null,id:-1,name:"/",owner:-1,status:""},t.setTeaching(a)}),window.setInterval(function(){scheduleVM.fetchSchedule(function(e,t){t.setSchedule(e.data,!0)},!0)},5e3),$(".dropdown-button").dropdown(),e.isLoaded=!0})}});