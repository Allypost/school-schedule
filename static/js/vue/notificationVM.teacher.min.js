window.notificationVM=new Vue({el:"#notifications",data:{users:{},notifications:{},teaching:{},loading:0,isLoaded:!1},filters:{date:function(t){return moment.utc(t).format("L")},time:function(t){return moment.utc(t).format("L LT")}},methods:{getUsersUrl:function(){return $(this.$el).attr("data-users")},fetchField:function(t,n){var e=this,i=t.hash();return e.loading^=i,isFunction(n)||(n=new Function),$.get(t).done(function(t){var e=t.data;n(!0,e),$(".collapsible").collapsible()}).fail(function(t){var e=t.errors;n(!1,e)}).always(function(){e.loading^=i})},fetchUsers:function(t){var n=this,e=n.getUsersUrl();return n.fetchField(e,function(e,i){e&&n.setUsers(i),isFunction(t)||(t=new Function),t()})},setUsers:function(t){this.$set(this,"users",t)},getTeachingUrl:function(){return $(this.$el).attr("data-teaching")},fetchTeaching:function(t){var n=this,e=this.getTeachingUrl();return n.fetchField(e,function(e,i){e&&n.setTeaching(i),isFunction(t)||(t=new Function),t()})},setTeaching:function(t){var n={};for(var e in t)if(t.hasOwnProperty(e)){var i=t[e];i.unseen=0,n[i.id]=i}this.$set(this,"teaching",n)},getNotificationsUrl:function(){return $(this.$el).attr("data-notifications")},fetchNotifications:function(t){var n=this,e=this.getNotificationsUrl();return n.fetchField(e,function(e,i){e&&n.setNotifications(i),isFunction(t)||(t=new Function),t()})},setNotifications:function(t){var n={};for(var e in t)if(t.hasOwnProperty(e)){n[e]=t[e].reverse();for(var i in n[e])n[e].hasOwnProperty(i)&&(n[e][i].unseen=0)}this.$set(this,"notifications",n)},fetchData:function(t){var n=this;isFunction(t)||(t=new Function);var e=function(){return n.$nextTick(function(){0===n.loading&&(n.hydrateUnseen(),$(".collapsible").collapsible(),t())})};n.fetchUsers(e),n.fetchTeaching(e),n.fetchNotifications(e)},seen:function(t,n){var e=moment.utc(t.date),i=moment.utc(n.seen);return e.isBefore(i)},hydrateUnseen:function(){var t=this,n=t.notifications,e=t.teaching,i=t.users,r={};for(var s in n)if(n.hasOwnProperty(s)){r[s]=0;var o=n[s];for(var a in o)if(o.hasOwnProperty(a)){var c=i[s];if(c){var f=o[a];for(var u in c)if(c.hasOwnProperty(u)){var h=c[u],l=this.seen(f,h);f.unseen+=!l,r[s]+=!l,l||t.$set(f,"unseen",f.unseen)}}}}for(var v in r)t.$set(e[v],"unseen",r[v]);return r}},mounted:function(){var t=this;t.fetchData(),t.isLoaded=!0,setInterval(t.fetchData,12e4),moment.locale("en-gb")}});