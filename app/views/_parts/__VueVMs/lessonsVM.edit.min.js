var lessonsVM=new Vue({el:"#lessons",data:{lessons:[],newLesson:"",loading:!0,deleting:!1,deleted:!1,deletedError:!1,error:!1,success:!1,isEditing:!1,lessonEditing:null,datePicker:null,dateFormats:{db:"YYYY-MM-DD",moment:"dddd D MMM YYYY",picker:"DD d M yyyy"}},filters:{formatDate:function(e){return e?moment(e,lessonsVM.dateFormats.db).format(lessonsVM.dateFormats.moment):""},reverseFormatDate:function(e){return e?moment(e,lessonsVM.dateFormats.moment).format(lessonsVM.dateFormats.db):""}},methods:{fetchLessons:function(){var e=this,t=$(this.$el).attr("data-fetch-url");$.get(t).done(function(t){e.lessons=t.data,e.loading=!1})},getLesson:function(){var e=getCsrf(),t={name:this.newLesson};if(this.isEditing){var s=this.lessonEditing;t.subject=s.id,t.due=s.due}return t[e.key]=e.value,t},dateSelect:function(e){var t=moment(e);this.dateSet(t)},dateHide:function(e){var t=e.$el[0].value;if(!t)return this.dateSet(null);var s=this.$options.filters.reverseFormatDate(t);this.dateSelect(s)},dateSet:function(e){return this.lessonEditing?null===e?this.lessonEditing.due=null:void(e.isValid()&&(this.lessonEditing.due=e.format(this.dateFormats.db))):void 0},editLesson:function(e){this.clearLesson(),this.newLesson=e.name,this.isEditing=!0,this.lessonEditing=e,Vue.set(e,"isEdited",!0),this.refreshDatepicker(),e.due&&this.datePicker.selectDate(new Date(e.due)),this.$nextTick(function(){Materialize.updateTextFields()})},cancelLesson:function(){this.clearLesson()},saveLesson:function(){var e=this;e.loading=!0;var t=this.$el.dataset.saveUrl,s=this.getLesson();$.post(t,s).done(function(t){e.isEditing?e.saveEditedLesson(t):e.saveNewLesson(t),e.clearLesson(),e.btnStatus("success")}).fail(function(t){e.displayErrors(t)}).always(function(){e.loading=!1})},deleteLesson:function(){var e=this;swal({title:"Delete lesson",text:"Are you sure you want to delete the lesson?",type:"warning",showCancelButton:!0,confirmButtonText:"Delete",allowOutsideClick:!0,confirmButtonColor:"#f44336"}).then(function(){e.deletePropagate()},function(){})},deletePropagate:function(e){var t=this.getLesson(),s=this,n=this.$el.dataset.deleteUrl;e||(e=function(){}),s.loading=!0,s.deleting=!0,$.post(n,t).done(function(){s.lessons.splice(s.lessons.indexOf(s.lessonEditing),1),Materialize.toast("Lesson deleted",1500,"status success"),s.btnStatus("deleted"),s.clearLesson(),e(!0)}).fail(function(t){s.displayErrors(t),s.btnStatus("deletedError"),e(!1)}).always(function(){s.loading=!1,s.deleting=!1})},saveNewLesson:function(e){this.lessons.push(e.data)},saveEditedLesson:function(e){var t=this.lessonEditing,s=e.data;t.name=s.name},clearLesson:function(){this.lessonEditing&&Vue.set(this.lessonEditing,"isEdited",!1),this.newLesson="",this.isEditing=!1,this.lessonEditing=null,this.destroyDatepicker(),this.$nextTick(function(){Materialize.updateTextFields()})},btnStatus:function(e,t){var s=this;s[e]=!0;var n=function(){s[e]=!1,(t=t||function(){})()};return t||window.setTimeout(n,1500),n},displayErrors:function(e){e=e.responseJSON||{errors:["Something went wrong"]},this.btnStatus("error");var t=e.errors;for(var s in t)t.hasOwnProperty(s)&&Materialize.toast(t[s],5e3,"status error")},destroyDatepicker:function(){this.datePicker&&(this.datePicker.destroy(),this.datePicker=null)},refreshDatepicker:function(){this.destroyDatepicker(),this.createDatepicker()},createDatepicker:function(){var e=this,t=new Date,s=t.getDate()+3;t.setDate(s);var n={language:"en",minDate:t,dateFormat:this.dateFormats.picker,autoClose:!0,clearButton:!0,onSelect:function(t,s){e.dateSelect(s)},onHide:function(t,s){s&&e.dateHide(t)},onRenderCell:function(e,t){var s=[0,6];if("day"==t){var n=e.getDay(),i=-1!=s.indexOf(n);return{disabled:i}}}},i=$("#datepicker").datepicker().data("datepicker");i.update(n),this.datePicker=i}},mounted:function(){this.createDatepicker()}});